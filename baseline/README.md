# Бейзлайн

## Описание

Бейзлайн представляет из себя использование модели CLIP для поиска среди кадров видео с reduce до компонентов
В качестве бейзлайна мы выбрали решение задачи Text-to-image-to-video

Текущий поисковый индекс представляет из себя:

- `index.pkl` - база кадров из 322 видео, фреймированных по одной секунде
- `metadata.pkl` - описание каждого кадра
- `thumbnails.pkl` - фреймированные превью к видео

Для формирования файлов использовались команды c дефолтными параметрами

```shell
python -m vs.cli local_index_pipe

python -m vs.cli local_thumbnail

```

## Описание процесса

### Разметка
Для оценки нами был сформирован размеченный датасет на 323 видео, к каждому из которому был сформированы теги. Теги были переведены на английский с помощью пакета `deep_translate`

1. Массив был нормализован до пары `tag_en` - `video`. 
2. По ним был сформирован пул релевантных ведио

### Движок

Мы написали поисковый движок на базе файлов локального индекса (о них было сказано выше)

Движок представяет из себя несколько подряд идущих запросов и трансформаций:
- Запрос проходит через модель CLIP
  - Для текста мы просто нормализуем полученный вектор по норме 2
  - Для изображений:
    - Вектор сначала пересчитывается по формуле $sign(x)*|x|^{\frac{1}{4}}$ - power norm, это помогает бороться с коротким плато и резким падением схожести векторов
    - После чего вектор нормализуется по норме 2
- Запрос сравнивается с базой данных
  - Эта часть кода вынесена на GPU, и даже по расширенной базе данных (7к изображений и видеофайлов) занимает 0.02 секунды на rtx 3080 (при условии, что частота взятия кадров 1 кадр в секунду)
  - Для сравнения используется cosine `similarity`
  - Все кадры для которых схожесть с запросом ниже frame_threshold игнорируются
- Ответы базы данных проходят через этап слияния
  - Для каждого видео ищутся самый первый и последний кадры попавшие в ответ базы данных
  - Считается `percentile` для массива значений схожести кадров, если он больше заданного `video_threshold`, то видео отправляется пользователю
- (опционально) Выбираются `limit` видеофайлов с лучшей схожестью

Важные моменты:

За качество и количество запросов отвечают четыре параметра: `frame_threshold`, `percentile`, `video_threshold`, `limit`

Между ними есть сложная связь:
- Увеличение percentile - значит, что меньше кадров должны будут соответсвовать запросу, так при percentile равном 0.9, только 10% кадров должны быть больше чем video_threshold, стоит заметить, что значения меньше 0.7 могут приводить к нестабильным и некачественным ответам
- Увеличение frame_threshold - ведёт к увеличению расчитанного персентиля для каждого из видео, но уменьшает длину полученных отрезков видео для конечного пользователя
  
**Для оценки качества нашего пайплайна на запросы мы предлагаем использовать метрику ранжирования **Average Precision at K**:**

$$ 
AP\@k = \sum_k (R_k - R_{k-1}) P_k 
$$ 

**Для оценки общего качества (агрегирующая) - MAP@K**

$$
MAP\@K = \frac{1}{K} \sum_{n=1}^{K} AP\@n 
$$



### Результаты


Общая метрика получилась невысокой - 31% по `MAP@K` по всем запросам. Мысли по работе:

1. Провести более детальную аналитику и чистку первоначального набора тегов
2. Осуществить проверку различных комбинаций параметров (thresholds) для улучшения поиска 
3. Попробовать другие подход

Метрики по запросам:

|    | query              |   total_relevant |   total_predicted |   precision@10 |   recall@10 |   f1_score@10 |   average_precision@10 |
|---:|:-------------------|-----------------:|------------------:|---------------:|------------:|--------------:|-----------------------:|
|  8 | dog                |               19 |                20 |            0.9 |   0.473684  |           0.9 |              0.9       |
| 14 | horse              |               19 |                20 |            0.9 |   0.473684  |           0.9 |              0.89      |
|  3 | car                |               22 |                20 |            0.8 |   0.363636  |           0.8 |              0.743492  |
| 12 | glasses            |               52 |                20 |            0.6 |   0.115385  |           0.6 |              0.498333  |
|  5 | cat                |               17 |                20 |            0.5 |   0.294118  |           0.5 |              0.363889  |
|  2 | beard              |               30 |                20 |            0.6 |   0.2       |           0.6 |              0.358413  |
|  7 | cooking            |               36 |                20 |            0.6 |   0.166667  |           0.6 |              0.349365  |
|  4 | cartoon            |               23 |                20 |            0.4 |   0.173913  |           0.4 |              0.341667  |
| 21 | mustache           |               43 |                20 |            0.4 |   0.0930233 |           0.4 |              0.332143  |
|  9 | drawing            |               21 |                20 |            0.4 |   0.190476  |           0.4 |              0.326667  |
|  1 | animal             |               35 |                20 |            0.5 |   0.142857  |           0.5 |              0.32381   |
| 10 | food               |               50 |                20 |            0.5 |   0.1       |           0.5 |              0.315556  |



### Бонус

Также удалось сделать:

- Крутой сервис
- Пакет с общими модулями
- CLI инструмент для запуска пайплайнов


### В стадии разработки:

- Проведены предварительные тесты по усреднению векторов для отрезков видео
  - Такой механизм позволяет сжать базу данных, а при правильном методе усреднения потенциально позволяет не терять информаци и извлекать новую
  - Первичные результаты тестов, для простых методов, работают и приводят к удовлетворительным результатам, однако теряют инфомарцию о деталях кадров, что является нежелательным
  - Протестированы отрезки в 5 секунд и методы mean и median
  - Планируется проверить различные отрезки времени и методы типа PCA, Autoencoder для выбора важной информации
